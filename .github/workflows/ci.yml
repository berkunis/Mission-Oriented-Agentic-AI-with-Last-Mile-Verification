name: CI

# =============================================================================
# V0 Research Prototype CI
# =============================================================================
# This CI is intentionally scoped for a verification-first research prototype.
# Focus: Core correctness (verifiers, agent controller) and security scanning.
#
# Out of scope for V0 (future production hardening):
# - Multi-version Python matrix
# - Strict lint enforcement
# - Strict type checking
# - Docker builds and container scanning
# - Integration tests
# - API and deployment validation
# =============================================================================

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===========================================================================
  # BLOCKING JOBS - Must pass for CI to succeed
  # ===========================================================================

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    # Single Python version for V0 research prototype
    # Multi-version matrix is future production hardening work
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests for verifiers and agent controller
        # Coverage threshold is relaxed for V0 prototype
        # Full coverage enforcement is future production hardening
        run: |
          pytest tests/unit/ -v --cov=src/nl_to_sql --cov-report=term-missing --cov-fail-under=0

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit

      - name: Run Bandit security scan
        run: bandit -r src/ -ll -ii

  # ===========================================================================
  # NON-BLOCKING JOBS - Informational only, failures don't block CI
  # ===========================================================================

  lint:
    name: Lint (Non-blocking)
    runs-on: ubuntu-latest
    # Non-blocking: Strict lint enforcement is future production hardening
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff linter
        run: ruff check src/ tests/ || echo "::warning::Lint issues found (non-blocking for V0 prototype)"

      - name: Run Ruff formatter check
        run: ruff format --check src/ tests/ || echo "::warning::Format issues found (non-blocking for V0 prototype)"

  type-check:
    name: Type Check (Non-blocking)
    runs-on: ubuntu-latest
    # Non-blocking: Strict type checking is future production hardening
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy
          pip install -e ".[dev]"

      - name: Run MyPy
        run: mypy src/ || echo "::warning::Type check issues found (non-blocking for V0 prototype)"

  # ===========================================================================
  # SKIPPED JOBS - Out of scope for V0 research prototype
  # ===========================================================================

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    if: false  # Skipped: Container builds are out of scope for V0 research prototype
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/docker/Dockerfile
          push: false
          tags: nl-to-sql-verified:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: nl-to-sql-verified:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: false  # Skipped: Integration tests are out of scope for V0 research prototype
    needs: [docker]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"

      - name: Run integration tests
        run: pytest tests/integration/ -v -m integration --ignore=tests/integration/__init__.py
